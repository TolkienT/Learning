<!DOCTYPE html>
<html>
<head>
    <title>SignalR JavaScript 客户端</title>
    <!-- 引入 SignalR 客户端库 -->
    <script src="signalr.min.js"></script>
</head>
<body>
    <h1>SignalR 聊天示例</h1>
    <div>
        <input type="text" id="userInput" placeholder="用户名" />
        <input type="text" id="messageInput" placeholder="消息内容" />
        <button id="sendButton">发送</button>
    </div>
    <ul id="messagesList"></ul>

    <script>
        // 获取DOM元素
        const userInput = document.getElementById('userInput');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const messagesList = document.getElementById('messagesList');

        // 创建连接
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("http://localhost:5231/chatHub") // 替换为你的Hub地址
            .configureLogging(signalR.LogLevel.Information) // 日志级别
            .withAutomaticReconnect() // 自动重连
            .build();

        // 连接关闭时的处理
        connection.onclose(async () => {
            await startConnection();
        });

        // 接收消息的处理
        connection.on("ReceiveMessage", (user, message) => {
            const li = document.createElement("li");
            li.textContent = `${user}: ${message}`;
            messagesList.appendChild(li);
        });

        // 发送消息
        sendButton.addEventListener("click", async () => {
            const user = userInput.value;
            const message = messageInput.value;
            
            try {
                await connection.invoke("SendMessage", user, message);
                messageInput.value = "";
            } catch (err) {
                console.error(err);
            }
        });

        // 启动连接
        async function startConnection() {
            try {
                await connection.start();
                console.log("SignalR 连接已建立");
            } catch (err) {
                console.log("连接失败，5秒后重试...", err);
                setTimeout(startConnection, 5000);
            }
        }

        // 开始连接
        startConnection();
    </script>
</body>
</html>